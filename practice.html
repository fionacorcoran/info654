<!DOCTYPE html>
<html lang="en">
    <head> 
        <meta charset="UTF-8">
        <title>Tree Census</title>
        <link rel="stylesheet" type="text/css" href="practice.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script>
            const APP_TOKEN = "EuUJxbkjULlp0gbbri4FLO9hK";
            // Neighborhood dropdown menu for tree-report
            async function loadNeighborhoods() {
                const dropdown = document.getElementById('neighborhood');
                dropdown.innerHTML = "<option>Loading...</option>";

                const url = `https://data.cityofnewyork.us/resource/uvpi-gqnh.json?$select=distinct nta_name&$order=nta_name&$$app_token=${APP_TOKEN}`;

                try {
                const response = await fetch(url);
                const json = await response.json();

                dropdown.innerHTML = "<option value=''>Select a Neighborhood</option>";

                json.forEach(row => {
                    const neighborhood = row.nta_name;
                    if (neighborhood) {
                    const option = document.createElement('option');
                    option.value = neighborhood;
                    option.textContent = neighborhood;
                    dropdown.appendChild(option);
                    }
                });
            } catch (err) {
            console.error("Error loading neighborhoods:", err);
            dropdown.innerHTML = "<option>Error loading data</option>";
            }
            }
        // Fetch total number of trees per neighborhood
        async function fetchTreeCount (neighborhood) {
            const totalResult = document.getElementById('tree-count');
            totalResult.innerHTML ="";

            const url2015 = `https://data.cityofnewyork.us/resource/uvpi-gqnh.json?$select=count(tree_id) as total2015&$where=nta_name='${neighborhood}'&$$app_token=${APP_TOKEN}`;
            const url2005 = `https://data.cityofnewyork.us/resource/29bw-z7pj.json?$select=count(tree_dbh) as total2005&$where=nta_name='${neighborhood}'&$$app_token=${APP_TOKEN}`;
            try {
                const [response2015, response2005] = await Promise.all([
                    fetch(url2015), fetch(url2005)
                ]);
                const json2015 = await response2015.json();
                const json2005 = await response2005.json();
                
                const total2015 = json2015?.[0]?.total2015 ?? 0;
                const total2005 = json2005?.[0]?.total2005 ?? 0;
                
                //Calculate change in # of trees
                const change = total2015 - total2005;

                totalResult.innerHTML = `<b>Total trees in ${neighborhood}:</b><br>
                <b>2015 Census:</b> ${total2015}<br>
                <b>2005 Census:</b> ${total2005}<br>
                <b>Change over time:</b> ${change}`;

            } catch (err) {
                console.error("Error fetching data:", err);
                totalResult.innerHTML = "Error fetching total tree count.";
            }
        }
            // Fetch top 20 trees per neighborhood
            async function fetchTreeReport() {
                const dropdown = document.getElementById('neighborhood');
                const neighborhood = dropdown.value.trim();
                const results = document.getElementById('results');
                const totalResults = document.getElementById('tree-count');
                results.innerHTML = "";
                totalResults.innerHTML = "";

            if (!neighborhood) {
                alert("Please select a neighborhood!");
                return;
            }

            const url = `https://data.cityofnewyork.us/resource/uvpi-gqnh.json?$select=spc_common,count(*) as quantity&$where=nta_name='${neighborhood}'&$group=spc_common&$order=quantity DESC&$limit=20&$$app_token=${APP_TOKEN}`;

            try {
            const response = await fetch(url);
            const json = await response.json();

            const identifiedTrees = json.filter(row => row.spc_common && row.spc_common.toLowerCase() !== "unknown");

            if (!identifiedTrees.length) {
                results.innerHTML = "<li>No results found.</li>";
                return;
            } else {
            identifiedTrees.forEach(row => {
                const li = document.createElement('li');
                li.textContent = `${row.spc_common}: ${row.quantity}`;
                results.appendChild(li);
            });
            } fetchTreeCount(neighborhood);
        } catch (err) {
            console.error("Fetch error:", err);
            results.innerHTML = "<li>Error fetching data.</li>";
            }
        }
        window.onload = loadNeighborhoods;
         </script>
    </head> 
    <body>
        <div id="tree-report">
            <h2>NYC Neighborhood Tree Report (2015 Census Data)</h2>
            <p>Select a neighborhood to see its top 20 most common tree species and counts.</p>
            
            <select id="neighborhood" class="dropdown-menu">
                <option value="">Loading neighborhoods...</option>
            </select>
            <button onclick="fetchTreeReport()">Get Tree Report</button>
            
            <ul id="results"></ul>
            <p id="tree-count"></p>
        </div>
        <div class ="marquee">
            <p class ="marquee-scroll"><b>THE 2025 TREE CENSUS IS UNDERWAY!&nbsp;&nbsp;&nbsp;HAVE YOUR TREES BEEN COUNTED?</b></p>
            <p class ="marquee-scroll"><b>THE 2025 TREE CENSUS IS UNDERWAY!&nbsp;&nbsp;&nbsp;HAVE YOUR TREES BEEN COUNTED?</b></p>
        </div>
    </body> 
</html>